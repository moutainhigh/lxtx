{extend name="$_admin_base_layout" /}

{block name="content"}
    {notempty name="page_tips"}
    <div class="alert alert-{$tips_type} alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
        <p>{$page_tips}</p>
    </div>
    {/notempty}
    <div class="row">
        <div class="col-md-12">
            <div class="block">
                {empty name="Think.get._pop"}
                {notempty name="tab_nav"}
                <ul class="nav nav-tabs">
                    {volist name="tab_nav['tab_list']" id="tab"}
                    <li {eq name="tab_nav.curr_tab" value="$key"}class="active"{/eq}>
                    <a href="{$tab.url}">{$tab.title}</a>
                    </li>
                    {/volist}
                    <li class="pull-right">
                        <ul class="block-options push-10-t push-10-r">
                            <li>
                                <button type="button" data-toggle="block-option" data-action="refresh_toggle" data-action-mode="demo"><i class="si si-refresh"></i></button>
                            </li>
                            <li>
                                <button type="button" data-toggle="block-option" data-action="fullscreen_toggle"></button>
                            </li>
                        </ul>
                    </li>
                </ul>
                {else/}
                <div class="block-header bg-gray-lighter">
                    <ul class="block-options">
                        <li>
                            <button type="button" data-toggle="block-option" data-action="refresh_toggle" data-action-mode="demo"><i class="si si-refresh"></i></button>
                        </li>
                        <li>
                            <button type="button" data-toggle="block-option" data-action="fullscreen_toggle"></button>
                        </li>
                    </ul>
                    <h3 class="block-title">{$page_title|default=""}</h3>
                </div>
                {/notempty}
                {/empty}
                <div class="block-content tab-content">
                    <div class="tab-pane active">
                        <div class="block-content">
                            <form class="form-horizontal form-builder row" name="form-builder" action="{$post_url|default=''}" method="post">
                            
                                {empty name="form_items"}
                                <div class="form-empty">
                                    <p class="text-center text-muted empty-info">
                                        <i class="fa fa-database"></i> 暂无数据<br>
                                    </p>
                                </div>
                                {else /}
                                    {volist name="form_items" id="form"}
                                        {switch name="form.type"}
                                            {case value="bmap"}
                                                {// 百度地图 }
                                                {include file="./application/common/builder/form/items/bmap.html" type='' /}
                                            {/case}

                                            {case value="button"}
                                                {// 按钮 }
                                                {include file="./application/common/builder/form/items/button.html" type='' /}
                                            {/case}

                                            {case value="checkbox"}
                                                {// 多选 }
                                                {include file="./application/common/builder/form/items/checkbox.html" type='' /}
                                            {/case}

                                            {case value="ckeditor"}
                                                {// ckeditor编辑器 }
                                                {include file="./application/common/builder/form/items/ckeditor.html" type='' /}
                                            {/case}

                                            {case value="colorpicker"}
                                                {// 取色器 }
                                                {include file="./application/common/builder/form/items/colorpicker.html" type='' /}
                                            {/case}

                                            {case value="date"}
                                                {// 日期 }
                                                {include file="./application/common/builder/form/items/date.html" type='' /}
                                            {/case}

                                            {case value="daterange"}
                                                {// 日期范围 }
                                                {include file="./application/common/builder/form/items/daterange.html" type='' /}
                                            {/case}

                                            {case value="datetime"}
                                                {// 日期时间 }
                                                {include file="./application/common/builder/form/items/datetime.html" type='' /}
                                            {/case}

                                            {case value="editormd"}
                                                {// markdown编辑器 }
                                                {include file="./application/common/builder/form/items/editormd.html" type='' /}
                                            {/case}

                                            {case value="file"}
                                                {// 单文件上传 }
                                                {include file="./application/common/builder/form/items/file.html" type='' /}
                                            {/case}

                                            {case value="files"}
                                                {// 多文件上传 }
                                                {include file="./application/common/builder/form/items/files.html" type='' /}
                                            {/case}

                                            {case value="group"}
                                                {// 分组 }
                                                {include file="./application/common/builder/form/items/group.html" type='' /}
                                            {/case}

                                            {case value="hidden"}
                                                {// 隐藏 }
                                                {include file="./application/common/builder/form/items/hidden.html" type='' /}
                                            {/case}

                                            {case value="icon"}
                                                {// 图标选择器 }
                                                {include file="./application/common/builder/form/items/icon.html" type='' /}
                                            {/case}

                                            {case value="image"}
                                                {// 单图片上传 }
                                                {include file="./application/common/builder/form/items/image.html" type='' /}
                                            {/case}

                                            {case value="images"}
                                                {// 多图片上传 }
                                                {include file="./application/common/builder/form/items/images.html" type='' /}
                                            {/case}

                                            {case value="jcrop"}
                                                {// 图片裁剪 }
                                                {include file="./application/common/builder/form/items/jcrop.html" type='' /}
                                            {/case}

                                            {case value="linkage"}
                                                {// 联动下拉框 }
                                                {include file="./application/common/builder/form/items/linkage.html" type='' /}
                                            {/case}

                                            {case value="linkages"}
                                                {// 多级联动下拉框 }
                                                {include file="./application/common/builder/form/items/linkages.html" type='' /}
                                            {/case}

                                            {case value="masked"}
                                                {// 格式文本 }
                                                {include file="./application/common/builder/form/items/masked.html" type='' /}
                                            {/case}

                                            {case value="number"}
                                                {// 数字 }
                                                {include file="./application/common/builder/form/items/number.html" type='' /}
                                            {/case}

                                            {case value="password"}
                                                {// 密码 }
                                                {include file="./application/common/builder/form/items/password.html" type='' /}
                                            {/case}

                                            {case value="radio"}
                                                {// 单选 }
                                                {include file="./application/common/builder/form/items/radio.html" type='' /}
                                            {/case}

                                            {case value="range"}
                                                {// 范围 }
                                                {include file="./application/common/builder/form/items/range.html" type='' /}
                                            {/case}

                                            {case value="select"}
                                                <div class="form-group col-md-12" id="form_group_tmid">
                                                    <label class="col-xs-12" for="tmid">模板ID</label>
                                                    <div class="col-sm-12">
                                                        <select class="js-select2 form-control" id="tmid" name="tmid" data-allow-clear="true" data-placeholder="请选择一项" >
                                                            <option></option>
                                                            {volist name="tmp" id="vo" key="k"}
                                                            <option value="{$vo.template_id}" data-content="{$vo.content}">{$vo.name}</option>
                                                            {/volist}
                                                        </select>
                                                        <input type="hidden" id="TemplateName" name="TemplateName" />
                                                        <input id="TaskValue" type="hidden" name="TaskValue" class="span12" />

                                                    </div>
                                                </div>
                                                <div style="clear:both"></div>
                                                <div style="background:#eee; padding:10px">
                                                    <div id="template-msg-editor" class="template-msg-editor">
                                                        <div class="template-msg-title"></div>
                                                        <div class="template-msg-main"></div>
                                                    </div>
                                                </div>
                                                <input type="hidden" id="tempcontent">
                                            {/case}

                                            {case value="select2"}
                                                {// 下拉多选 }
                                                {include file="./application/common/builder/form/items/select2.html" type='' /}
                                            {/case}

                                            {case value="sort"}
                                                {// 排序 }
                                                {include file="./application/common/builder/form/items/sort.html" type='' /}
                                            {/case}

                                            {case value="static"}
                                                {// 静态文本 }
                                                {include file="./application/common/builder/form/items/static.html" type='' /}
                                            {/case}

                                            {case value="summernote"}
                                                {// summernote编辑器 }
                                                {include file="./application/common/builder/form/items/summernote.html" type='' /}
                                            {/case}

                                            {case value="switch"}
                                                {// 开关 }
                                                {include file="./application/common/builder/form/items/switch.html" type='' /}
                                            {/case}

                                            {case value="tags"}
                                                {// 标签 }
                                                {include file="./application/common/builder/form/items/tags.html" type='' /}
                                            {/case}

                                            {case value="text"}
                                                {// 单行文本 }
                                                {include file="./application/common/builder/form/items/text.html" type='' /}
                                            {/case}

                                            {case value="time"}
                                                {// 时间 }
                                                {include file="./application/common/builder/form/items/time.html" type='' /}
                                            {/case}

                                            {case value="textarea|array"}
                                                {// 文本框|数组 }
                                                {include file="./application/common/builder/form/items/textarea.html" type='' /}
                                            {/case}

                                            {case value="ueditor"}
                                                {// 百度编辑器 }
                                                {include file="./application/common/builder/form/items/ueditor.html" type='' /}
                                            {/case}

                                            {case value="wangeditor"}
                                                {// wang编辑器 }
                                                {include file="./application/common/builder/form/items/wangeditor.html" type='' /}
                                            {/case}
                                        {/switch}
                                    {/volist}
                                {/empty}
                                <div class="form-group col-md-12">
                                    <div class="col-xs-12">
                                        {php}if(isset($btn_hide) && !in_array('submit', $btn_hide)):{/php}
                                        <button class="btn btn-minw btn-primary {eq name="ajax_submit" value="true"}ajax-post{/eq}" target-form="form-builder" type="submit" >
                                            {$btn_title['submit']|default='提交'}
                                        </button>
                                        {php}endif;{/php}

                                        {empty name="Think.get._pop"}
                                        {php}if(isset($btn_hide) && !in_array('back', $btn_hide)):{/php}
                                        <button class="btn btn-default" type="button" onclick="javascript:history.back(-1);return false;">
                                            {$btn_title['back']|default='返回'}
                                        </button>
                                        {php}endif;{/php}
                                        {/empty}

                                        {// 额外按钮}
                                        {$btn_extra|default=''}
                                    </div>
                                </div>
                                
                            
                                
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {// 图标 }
    {notempty name="_icon"}
    <div id="icon_tab" style="display:none">
        <div id="icon_search">
            <form onsubmit="return false;">
                <div class="input-group input-group-lg">
                    <div class="input-group-addon">搜索图标</div>
                    <input class="js-icon-search form-control" type="text" placeholder="例如: 输入 home 或 user">
                </div>
            </form>
        </div>
        <ul  class="nav nav-tabs nav-simple">
            <li class="active">
                <a href="#fa" data-toggle="tab">Font Awesome</a>
            </li>
            <li class="">
                <a href="#gl" data-toggle="tab">Glyphicons</a>
            </li>
            <li class="">
                <a href="#sl" data-toggle="tab">SIMPLE LINE</a>
            </li>
        </ul>
        <div class="tab-content js-icon-content" style="padding: 10px">
            <div class="tab-pane fade active in" id="fa">
                {include file="./application/common/builder/form/icon/fa.html" /}
            </div>
            <div class="tab-pane fade" id="gl">
                {include file="./application/common/builder/form/icon/gl.html" /}
            </div>
            <div class="tab-pane fade" id="sl">
                {include file="./application/common/builder/form/icon/sl.html" /}
            </div>
        </div>
    </div>
    {/notempty}
{// 额外HTML代码 }
{$extra_html|default=''}
{/block}









{block name="style"}
    {notempty name="_editormd"}
    <link href="__LIBS__/editormd/css/editormd.min.css" rel="stylesheet" type="text/css" />
    {/notempty}

    {volist name="css_list" id="vo"}
    <link rel="stylesheet" href="__MODULE_CSS__/{$vo}.css">
    {/volist}

    {// 额外CSS代码 }
    {$extra_css|default=''}
{/block}

{block name="script"}
    {notempty name="_ueditor"}
    <script src="__LIBS__/ueditor/ueditor.config.js"></script>
    <script src="__LIBS__/ueditor/ueditor.all.min.js"></script>
    {/notempty}

    {notempty name="_ckeditor"}
    <script src="__LIBS__/ckeditor/ckeditor.js"></script>
    {/notempty}

    {volist name="js_list" id="vo"}
    <script src="__MODULE_JS__/{$vo}.js"></script>
    {/volist}

    {// 额外JS代码 }
    {$extra_js|default=''}


    <div class="modal hide fade" id="myModal" tabindex="-1" role="document" style="width:560px;border-radius: 6px;left:50%; margin-left: -280px;top:10%;">
    <div class="modal-header" style="background: #efefef;border-bottom: 1px solid #CDCDCD; height: auto; padding: 8px 15px 5px;">
        <button class="close" type="button" data-dismiss="modal">×</button>
        <h3 id="myModalLabel" style="font-size: 12px;text-shadow: 0 1px 0 #ffffff;    line-height: 30px;    font-weight: normal;">修改属性</h3>
    </div>
    <div class="modal-body" style="    background-color: #fff;">
        <form id="add-data-form" class="form-horizontal">
            <input type="hidden" name="did" />
            <div class="control-group">
                <label class="control-label" for="keyvalue">值</label>
                <div class="controls">
                    <input class="span4" type="text" name="keyvalue" id="keyvalue" />
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="">颜色</label>
                <div class="controls">
                    <select class="span4" name="color" id="color" data-bind="value: color">
                        <option value="#0000ff">蓝</option>
                        <option value="#000000">黑</option>
                        <option value="#ff0000">红</option>
                        <option value="#ff1493">粉</option>
                        <option value="#9370db">紫</option>
                    </select>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for=""></label>
                <!--
                <div class="controls">
                    可使用 {nickname} 占位符, 发送时会被替换成用户昵称<br /><br />
                    可使用 {score} 占位符, 发送时会被替换成书币数量<br/>
                </div>
                -->
            </div>
        </form>
    </div>
    <div class="modal-footer"  style="background-color: #f5f5f5;border-top: 1px solid #ddd;-webkit-border-radius: 0 0 6px 6px;
    -moz-border-radius: 0 0 6px 6px;border-radius: 0 0 6px 6px;-webkit-box-shadow: inset 0 1px 0 #fff;-moz-box-shadow: inset 0 1px 0 #fff;
    box-shadow: inset 0 1px 0 #fff;">
        <button type="button" id="okEditBtn" class="btn btn-primary">
            <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>确定
        </button>
        <button type="button" class="btn btn-default" data-dismiss="modal">
            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>取消
        </button>
    </div>
</div>
<link href="/css/jquery.webui-popover.min.css" rel="stylesheet" />
<link href="/css/font-awesome.min.css" rel="stylesheet" />

<script src="/js/jquery.webui-popover.min.js"></script>

<script>
    $(function() {
        $('#templateMsgMenu').addClass("active");
        $('#tmid').val("");
        $('.showExample').webuiPopover({
            html: true,
            trigger: 'hover',
            placement: 'top',
            content: function() {
                return '<div style="width:240px;min-height:430px"><img style="max-width:100%" src="/Content/manager/images/guide-user-center.jpg" /></div>';
            }
        });
    });
    $("#tmid").change(function () {
        var selectObj = this.options[this.options.selectedIndex];
        var text = selectObj.text;
        var content = selectObj.getAttribute("data-content");
        $("#TemplateName").val(text);
        $(".template-msg-title").html(text);
        var cons = content.split('\n');
        var res = "<br/>";
        for (var i in cons) {
            if (cons[i].trim() == '') continue;
            res += getRow(cons[i]);
        }
        $(".template-msg-main").html(res);
    });
   
    function getRow(data) {
        var par = /\{{1,2}(\w+)\.DATA\}{1,2}/g;
        var res;
        var str = data;
        while (res = par.exec(data)) {
            console.log(res[0]+"---->"+res[1])
            var ss = '<span class="template-msg-field" data-value="" data-color="" data-key="' + res[1] + '">' +
                '<span class="template-msg-field-value"></span> ' +
                '<i onclick="showEdit(\'' + res[1] + '\')" title="点击修改" class="icon icon-edit"></i>' +
            '</span> ';
            str = str.replace(res[0], ss);
        }
        return str + "</br>";
    }

    var curKey = "";
    function showEdit(key) {
        curKey = key;
        $("#myModal").modal("show");
        $("#myModal").removeClass("hide");
    }

    $("#okEditBtn").click(function() {
        var titleSpan = $(".template-msg-field[data-key=" + curKey + "] .template-msg-field-value");
        titleSpan.css("color",$("#color").val());
        titleSpan.html($("#keyvalue").val());
        titleSpan.parent().attr('data-color', $("#color").val());
        titleSpan.parent().attr('data-value', $("#keyvalue").val());
        $("#myModal").modal("hide");
        var isCom = true;
        var str = "{";
        $(".template-msg-field").each(function () {
            var keyvalue = $(this).attr("data-value");
            var color = $(this).attr("data-color");
            if (keyvalue == '') isCom = false;
            str += '"' + $(this).attr("data-key") + '":{';
            str += '"value":"' + keyvalue + '",';
            str += '"color":"' + color + '"},';
        });
        str = str.substring(0,str.length-1);
        str += '}';
        $("#keyvalue").val("");
        if (!isCom) return;
        $("#TaskValue").val(str);
    });
    
   
</script>





{/block}

